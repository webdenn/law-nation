generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// ==============================
/// RBAC MODULE
/// ==============================

/// ---------- core user model ----------
model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  phone        String?
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  version      Int      @default(1)

  // RBAC relations
  roles             UserRole[]
  refreshTokens     RefreshToken[]
  auditLogs         AuditLog[]
  assignedArticles  Article[]
}

/// ---------- roles ----------
model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       UserRole[]
  permissions RolePermission[]
}

/// ---------- permissions ----------
model Permission {
  id          String   @id @default(cuid())
  key         String   @unique
  description String?
  module      String? // optional grouping (e.g. "leads", "inventory", "auth")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles RolePermission[]
}

/// ---------- user <-> role ----------
model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
}

/// ---------- role <-> permission ----------
model RolePermission {
  roleId       String
  permissionId String
  assignedAt   DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

/// ---------- audit logging ----------
model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  roleName   String? // snapshot of role at time of action
  action     String  // e.g. "ROLE_ASSIGNED", "LOGIN", "PERMISSION_REVOKED"
  resource   String  // e.g. "user", "role", "permission"
  resourceId String?
  payload    Json?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}

model RefreshToken {
  id        String   @id @default(cuid())
  tokenHash String
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)

  user User @relation(fields: [userId], references: [id])
}

//ARTICLE SUBMISSION MODULE

enum ArticleStatus {
  PENDING_ADMIN_REVIEW
  ASSIGNED_TO_EDITOR
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  REJECTED
}

model Article {
  id                String        @id @default(cuid())
  
  // Author Info (Guest Submission)
  authorName        String
  authorEmail       String
  authorPhone       String?
  authorOrganization String?
  
  // Article Details
  title             String
  category          String
  abstract          String        @db.Text
  keywords          String?
  coAuthors         String?       @db.Text
  remarksToEditor   String?       @db.Text
  
  // File Management
  originalPdfUrl    String
  currentPdfUrl     String        // Can be updated by editor
  
  // PDF Content Extraction (for web display)
  content           String?       @db.Text  // Extracted text from PDF
  contentHtml       String?       @db.Text  // Optional: formatted HTML version
  
  // Workflow
  status            ArticleStatus @default(PENDING_ADMIN_REVIEW)
  assignedEditorId  String?
  assignedEditor    User?         @relation(fields: [assignedEditorId], references: [id])
  
  // Timestamps
  submittedAt       DateTime      @default(now())
  reviewedAt        DateTime?
  approvedAt        DateTime?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Revisions
  revisions         ArticleRevision[]
  
  @@index([status])
  @@index([assignedEditorId])
  @@index([authorEmail])
}

model ArticleRevision {
  id          String   @id @default(cuid())
  articleId   String
  article     Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  pdfUrl      String
  uploadedBy  String?  // Editor ID if uploaded by editor
  comments    String?  @db.Text
  
  createdAt   DateTime @default(now())
  
  @@index([articleId])
}

// EMAIL VERIFICATION MODULE
model EmailVerification {
  id            String    @id @default(cuid())
  resourceId    String    // Temporary ID for the resource being verified
  resourceType  String    // Type: "ARTICLE", "USER", etc.
  email         String    // Email to be verified
  token         String    @unique // Verification token
  isVerified    Boolean   @default(false)
  verifiedAt    DateTime?
  ttl           DateTime  // Time-to-live (expiration timestamp - 48 hours)
  metadata      Json?     // Store temporary data (article details, file paths)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([token])
  @@index([email])
  @@index([ttl])
  @@index([isVerified])
}