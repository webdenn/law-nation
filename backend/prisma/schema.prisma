generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// ---------- core user model ----------
model User {
  id               String         @id @default(cuid())
  name             String
  email            String         @unique
  phone            String?
  passwordHash     String
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  version          Int            @default(1)
  assignedArticles Article[]
  auditLogs        AuditLog[]
  refreshTokens    RefreshToken[]
  roles            UserRole[]
}

/// ---------- roles ----------
model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       UserRole[]
}

/// ---------- permissions ----------
model Permission {
  id          String           @id @default(cuid())
  key         String           @unique
  description String?
  module      String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roles       RolePermission[]
}

/// ---------- user <-> role ----------
model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
}

/// ---------- role <-> permission ----------
model RolePermission {
  roleId       String
  permissionId String
  assignedAt   DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

/// ---------- audit logging ----------
model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  roleName   String?
  action     String
  resource   String
  resourceId String?
  payload    Json?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])
}

model RefreshToken {
  id        String   @id @default(cuid())
  tokenHash String
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id])
}

model Article {
  id                 String            @id @default(cuid())
  authorName         String
  authorEmail        String
  authorPhone        String?
  authorOrganization String?
  title              String
  category           String
  abstract           String
  keywords           String?
  coAuthors          String?
  remarksToEditor    String?
  originalPdfUrl     String
  currentPdfUrl      String
  status             ArticleStatus     @default(PENDING_ADMIN_REVIEW)
  assignedEditorId   String?
  submittedAt        DateTime          @default(now())
  reviewedAt         DateTime?
  approvedAt         DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  content            String?
  contentHtml        String?
  imageUrls          String[]
  thumbnailUrl       String?
  currentWordUrl     String?
  originalFileType   String            @default("pdf")
  originalWordUrl    String?
  assignedEditor     User?             @relation(fields: [assignedEditorId], references: [id])
  revisions          ArticleRevision[]

  @@index([status])
  @@index([assignedEditorId])
  @@index([authorEmail])
}

model ArticleRevision {
  id         String   @id @default(cuid())
  articleId  String
  pdfUrl     String
  uploadedBy String?
  comments   String?
  createdAt  DateTime @default(now())
  wordUrl    String?
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
}

model EmailVerification {
  id           String    @id @default(cuid())
  resourceId   String
  resourceType String
  email        String
  token        String    @unique
  isVerified   Boolean   @default(false)
  verifiedAt   DateTime?
  ttl          DateTime
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([token])
  @@index([email])
  @@index([ttl])
  @@index([isVerified])
}

enum ArticleStatus {
  PENDING_ADMIN_REVIEW
  ASSIGNED_TO_EDITOR
  PENDING_APPROVAL
  APPROVED
  REJECTED
  PUBLISHED
}
